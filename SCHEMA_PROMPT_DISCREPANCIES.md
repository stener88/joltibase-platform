# Schema vs AI Prompt Discrepancies Analysis

## Executive Summary

This document identifies critical mismatches between:
1. **Zod schemas** (`lib/email/blocks/schemas.ts`) - What the validation expects
2. **AI Generation Prompt** (`lib/ai/prompts.ts`) - What AI is instructed to generate
3. **AI Refinement Prompt** (`app/api/ai/refine-campaign/route.ts`) - What AI is instructed to modify

## Critical Issues Found

### üö® SEVERITY: HIGH - Block Will Fail Validation

#### 1. Hero Block - Extra Field in Prompt
**Location:** `lib/ai/prompts.ts` line 81

**Prompt says:**
```json
"settings": { 
  "lineHeight": "1.1"  // ‚ùå NOT in schema
}
```

**Schema requires:** (schemas.ts lines 224-238)
```typescript
HeroBlockSettingsSchema = z.object({
  backgroundColor: HexColorSchema.optional(),
  backgroundGradient: z.object({...}).optional(),
  padding: PaddingSchema,
  align: AlignmentSchema,
  headlineFontSize: PixelValueSchema,
  headlineFontWeight: z.number(),
  headlineColor: HexColorSchema,
  subheadlineFontSize: PixelValueSchema,
  subheadlineColor: HexColorSchema,
  // NO lineHeight!
})
```

**Impact:** Hero blocks generated by AI may include `lineHeight` which schema doesn't recognize. Schema is `.strict()` by default, so extra fields cause validation failure.

**Fix:** Remove `lineHeight` from hero block example in prompts.ts


#### 2. Testimonial Block - Missing `align` in Schema
**Location:** `lib/ai/prompts.ts` line 94, refine-campaign/route.ts line 178

**Prompt says:**
```json
"settings": {
  "align": "center"  // ‚ùå NOT in schema
}
```

**Schema requires:** (schemas.ts lines 290-302)
```typescript
TestimonialBlockSettingsSchema = z.object({
  backgroundColor: HexColorSchema.optional(),
  borderColor: HexColorSchema.optional(),
  borderWidth: z.number().optional(),
  borderRadius: PixelValueSchema.optional(),
  padding: PaddingSchema,
  quoteFontSize: PixelValueSchema,
  quoteColor: HexColorSchema,
  quoteFontStyle: z.enum(['normal', 'italic']),
  authorFontSize: PixelValueSchema,
  authorColor: HexColorSchema,
  authorFontWeight: z.number(),
  // NO align!
})
```

**Impact:** AI generates testimonial blocks with `align` field, validation fails.

**Fix:** Either add `align: AlignmentSchema` to TestimonialBlockSettingsSchema OR remove from prompts


#### 3. Comparison Block - COMPLETELY WRONG FIELD NAMES
**Location:** `app/api/ai/refine-campaign/route.ts` lines 106-109, `lib/ai/prompts.ts` lines 106-109

**Refine Prompt says:**
```json
"settings": {
  "beforeColor": "#fef2f2",      // ‚ùå WRONG
  "afterColor": "#f0fdf4",        // ‚ùå WRONG
  "labelColor": "#dc2626",        // ‚ùå WRONG
  "labelColorAfter": "#16a34a",   // ‚ùå WRONG
  "fontSize": "18px",             // ‚ùå WRONG
  "fontWeight": 600,              // ‚ùå WRONG
  "lineHeight": "1.6",            // ‚ùå WRONG
  "align": "left"                 // ‚ùå WRONG
}
```

**Schema actually requires:** (schemas.ts lines 357-369)
```typescript
ComparisonBlockSettingsSchema = z.object({
  beforeBackgroundColor: HexColorSchema,        // ‚úì Required
  afterBackgroundColor: HexColorSchema,         // ‚úì Required
  beforeLabelColor: HexColorSchema,             // ‚úì Required
  afterLabelColor: HexColorSchema,              // ‚úì Required
  labelFontSize: PixelValueSchema,              // ‚úì Required
  labelFontWeight: z.number(),                  // ‚úì Required
  contentFontSize: PixelValueSchema,            // ‚úì Required
  contentColor: HexColorSchema,                 // ‚úì Required
  borderRadius: PixelValueSchema.optional(),
  padding: PaddingSchema,                       // ‚úì Required
  cellPadding: z.number(),                      // ‚úì Required
})
```

**Impact:** ANY comparison block generated or refined will FAIL validation. This is a complete mismatch.

**Fix:** Update prompts to use correct field names:
- `beforeColor` ‚Üí `beforeBackgroundColor`
- `afterColor` ‚Üí `afterBackgroundColor`
- `labelColor` ‚Üí `beforeLabelColor`
- `labelColorAfter` ‚Üí `afterLabelColor`
- `fontSize` ‚Üí `contentFontSize`
- `fontWeight` ‚Üí `labelFontWeight`
- `lineHeight` ‚Üí REMOVE (not in schema)
- `align` ‚Üí REMOVE (not in schema)
- ADD: `cellPadding` (required)


#### 4. Divider Block - Wrong Field Name
**Location:** `lib/ai/prompts.ts` line 145

**Prompt says:**
```json
"settings": {
  "height": 1  // ‚ùå Should be "thickness"
}
```

**Schema requires:** (schemas.ts lines 199-206)
```typescript
DividerBlockSettingsSchema = z.object({
  style: z.enum(['solid', 'dashed', 'dotted', 'decorative']),
  color: HexColorSchema.optional(),
  thickness: z.number().optional(),  // ‚úì Correct name
  width: PixelValueSchema.or(z.literal('100%')).optional(),
  padding: PaddingSchema,
  align: AlignmentSchema.optional(),
})
```

**Impact:** AI generates divider blocks with `height` instead of `thickness`.

**Fix:** Change `"height": 1` to `"thickness": 1` in prompts


### üü° SEVERITY: MEDIUM - Missing Required Fields

#### 5. Text/Heading Blocks - Missing fontWeight and lineHeight
**Location:** Refinement API generates blocks without these fields

**Schema requires:** (schemas.ts lines 89-98 for Heading, 116-124 for Text)
```typescript
HeadingBlockSettingsSchema = z.object({
  fontSize: PixelValueSchema,
  fontWeight: z.number().int().min(100).max(900),  // ‚úì Required
  color: HexColorSchema,
  align: AlignmentSchema,
  backgroundColor: HexColorSchema.optional(),
  padding: PaddingSchema,
  lineHeight: z.string().regex(/^\d+(\.\d+)?$/),   // ‚úì Required
  letterSpacing: z.string().optional(),
})

TextBlockSettingsSchema = z.object({
  fontSize: PixelValueSchema,
  fontWeight: z.number().int().min(100).max(900),  // ‚úì Required
  color: HexColorSchema,
  align: AlignmentSchema,
  backgroundColor: HexColorSchema.optional(),
  padding: PaddingSchema,
  lineHeight: z.string().regex(/^\d+(\.\d+)?$/),   // ‚úì Required
})
```

**Current Error from User:**
```
Invalid input: expected number, received undefined - settings.fontWeight
Invalid input: expected string, received undefined - settings.lineHeight
```

**Impact:** When AI refines existing blocks and doesn't include these fields, validation fails.

**Fix:** Sanitization layer to provide defaults:
- `fontWeight`: 400 (text), 700 (heading)
- `lineHeight`: "1.6" (text), "1.2" (heading)


#### 6. Stats Block - Missing labelFontWeight
**Location:** Refinement might omit this

**Schema requires:** (schemas.ts lines 258-269)
```typescript
StatsBlockSettingsSchema = z.object({
  layout: z.enum(['2-col', '3-col', '4-col']),
  align: AlignmentSchema,
  valueFontSize: PixelValueSchema,
  valueFontWeight: z.number(),
  valueColor: HexColorSchema,
  labelFontSize: PixelValueSchema,
  labelFontWeight: z.number(),  // ‚úì Required (not optional!)
  labelColor: HexColorSchema,
  padding: PaddingSchema,
  spacing: z.number(),
})
```

**Impact:** Stats blocks might fail if `labelFontWeight` is omitted.

**Fix:** Ensure prompt example includes it (it does in prompts.ts line 87), add to sanitizer


## Summary of Required Changes

### 1. Update `lib/ai/prompts.ts`

**Line 81 - Hero Block:**
```diff
- "headlineColor": "#1f2937", "subheadlineFontSize": "20px", "subheadlineColor": "#6b7280", "lineHeight": "1.1" } }
+ "headlineColor": "#1f2937", "subheadlineFontSize": "20px", "subheadlineColor": "#6b7280" } }
```

**Line 94 - Testimonial Block:**
```diff
- "quoteFontSize": "20px", "quoteColor": "#1f2937", "quoteFontStyle": "italic", "authorFontSize": "15px", "authorColor": "#6b7280", "authorFontWeight": 600, "align": "center" } }
+ "quoteFontSize": "20px", "quoteColor": "#1f2937", "quoteFontStyle": "italic", "authorFontSize": "15px", "authorColor": "#6b7280", "authorFontWeight": 600 } }
```

**Lines 106-109 - Comparison Block:**
```diff
- { "id": "comparison-1", "type": "comparison", "position": 4,
-   "content": { "before": {"label": "BEFORE", "text": "Old way"}, "after": {"label": "AFTER", "text": "New way"} },
-   "settings": { "padding": {"top": 32, "bottom": 32, "left": 40, "right": 40}, "spacing": 24,
-     "beforeColor": "#fef2f2", "afterColor": "#f0fdf4", "labelColor": "#dc2626", "labelColorAfter": "#16a34a",
-     "fontSize": "18px", "fontWeight": 600, "lineHeight": "1.6", "align": "left" } }
+ { "id": "comparison-1", "type": "comparison", "position": 4,
+   "content": { "before": {"label": "BEFORE", "text": "Old way"}, "after": {"label": "AFTER", "text": "New way"} },
+   "settings": { "padding": {"top": 32, "bottom": 32, "left": 40, "right": 40}, 
+     "beforeBackgroundColor": "#fef2f2", "afterBackgroundColor": "#f0fdf4", 
+     "beforeLabelColor": "#dc2626", "afterLabelColor": "#16a34a",
+     "labelFontSize": "14px", "labelFontWeight": 700, 
+     "contentFontSize": "17px", "contentColor": "#111827",
+     "cellPadding": 24 } }
```

**Line 145 - Divider Block:**
```diff
- "settings": { "color": "#e5e7eb", "width": "100%", "height": 1, "style": "solid",
+ "settings": { "style": "solid", "color": "#e5e7eb", "thickness": 1, "width": "100%",
```

### 2. Update `app/api/ai/refine-campaign/route.ts`

**Lines 106-109 - Comparison Block Instructions:**
Same fixes as prompts.ts above

**Line 178 - Testimonial Requirements:**
```diff
- "settings": { "quoteFontSize" (string like "20px"), "quoteColor" (hex), "quoteFontStyle" ("normal" or "italic"), "authorFontSize" (string like "15px"), "authorColor" (hex), and "authorFontWeight" (number)
+ "settings": { "quoteFontSize" (string like "20px"), "quoteColor" (hex), "quoteFontStyle" ("normal" or "italic"), "authorFontSize" (string like "15px"), "authorColor" (hex), "authorFontWeight" (number), "padding" (object)
```
(Remove mention of align)


### 3. Create Sanitizer (NEW FILE)

Create `lib/ai/blocks/sanitizer.ts` to provide defaults for missing required fields:

```typescript
export function sanitizeBlock(block: any): any {
  const sanitized = { ...block };
  
  // Ensure settings object exists
  if (!sanitized.settings) {
    sanitized.settings = {};
  }
  
  // Type-specific sanitization
  switch (block.type) {
    case 'heading':
      if (sanitized.settings.fontWeight === undefined) {
        sanitized.settings.fontWeight = 700;
      }
      if (sanitized.settings.lineHeight === undefined) {
        sanitized.settings.lineHeight = "1.2";
      }
      break;
      
    case 'text':
      if (sanitized.settings.fontWeight === undefined) {
        sanitized.settings.fontWeight = 400;
      }
      if (sanitized.settings.lineHeight === undefined) {
        sanitized.settings.lineHeight = "1.6";
      }
      break;
      
    case 'stats':
      if (sanitized.settings.labelFontWeight === undefined) {
        sanitized.settings.labelFontWeight = 400;
      }
      break;
      
    // Add more as needed
  }
  
  return sanitized;
}
```

### 4. Apply Sanitizer in APIs

In both generate and refine APIs, before validation:
```typescript
// Sanitize blocks before validation
const sanitizedBlocks = aiResponse.blocks.map(sanitizeBlock);
const blockValidation = validateRefinedBlocks(sanitizedBlocks);
```

## Testing Checklist

- [ ] Generate campaign with hero block ‚Üí no lineHeight error
- [ ] Generate campaign with testimonial ‚Üí no align error
- [ ] Generate campaign with comparison ‚Üí validation passes with correct field names
- [ ] Generate campaign with divider ‚Üí thickness instead of height
- [ ] Refine campaign changing text ‚Üí fontWeight/lineHeight auto-filled
- [ ] Refine campaign adding stats block ‚Üí labelFontWeight present
- [ ] All block types validate successfully
- [ ] Rendered HTML still looks correct

## Validation Priority

1. **CRITICAL - Must fix before ANY campaign works:**
   - Comparison block field names (complete rewrite needed)
   
2. **HIGH - Blocks fail if used:**
   - Hero lineHeight (remove from prompt)
   - Testimonial align (remove from prompt)
   - Divider height‚Üíthickness (rename in prompt)
   
3. **MEDIUM - Fail during refinement:**
   - Text/Heading fontWeight/lineHeight (sanitizer)
   - Stats labelFontWeight (sanitizer)

